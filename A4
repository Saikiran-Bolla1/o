#!/usr/bin/env python3
"""
Add new MEASUREMENT blocks for ELF variables not present in the existing A2L file.

Usage:
  python scripts/add_new_symbols_to_a2l.py --a2l-in input.a2l --elf app.elf --a2l-out output.a2l --ecu-name MyECU

Dependencies:
  pip install pyelftools
"""

import argparse
import re
from pathlib import Path
from elftools.elf.elffile import ELFFile

def get_elf_symbols(elf_path):
    symbols = []
    with open(elf_path, "rb") as f:
        elf = ELFFile(f)
        for sec_name in (".symtab", ".dynsym"):
            sec = elf.get_section_by_name(sec_name)
            if not sec:
                continue
            for sym in sec.iter_symbols():
                if sym['st_info']['type'] == 'STT_OBJECT' and sym['st_value'] != 0:
                    symbols.append((sym.name, sym['st_value'], sym['st_size']))
    return symbols

def get_existing_measurements(a2l_lines):
    # Finds all MEASUREMENT block names
    measurement_re = re.compile(r"\bMEASUREMENT\s+(\S+)\s+\"")
    found = set()
    for line in a2l_lines:
        m = measurement_re.search(line)
        if m:
            found.add(m.group(1))
    return found

def append_measurements(a2l_lines, symbols, existing, ecu_name="MyECU"):
    # Find where to append: before /end MODULE or /end PROJECT
    end_module_idx = None
    for i, line in enumerate(a2l_lines[::-1]):
        if "/end MODULE" in line:
            end_module_idx = len(a2l_lines) - 1 - i
            break
    if end_module_idx is None:
        end_module_idx = len(a2l_lines)

    new_blocks = []
    added = 0
    for name, addr, size in symbols:
        if name not in existing:
            new_blocks.append(f"    /begin MEASUREMENT {name} \"{name}\"")
            new_blocks.append(f"      UINT {addr:#X} 1 0 65535")
            new_blocks.append(f"      ECU_ADDRESS {addr:#X}")
            new_blocks.append(f"      FORMAT \"%d\"")
            new_blocks.append(f"      /end MEASUREMENT")
            added += 1

    # Insert before /end MODULE or at end
    a2l_lines = a2l_lines[:end_module_idx] + new_blocks + a2l_lines[end_module_idx:]
    return a2l_lines, added

def main():
    parser = argparse.ArgumentParser(description="Add new MEASUREMENTs from ELF to existing A2L.")
    parser.add_argument("--a2l-in", required=True, type=Path, help="Input A2L file")
    parser.add_argument("--elf", required=True, type=Path, help="ELF file")
    parser.add_argument("--a2l-out", required=True, type=Path, help="Output A2L file")
    parser.add_argument("--ecu-name", default="MyECU", help="ECU name for A2L")
    args = parser.parse_args()

    symbols = get_elf_symbols(str(args.elf))
    a2l_lines = args.a2l_in.read_text(encoding="latin-1").splitlines()
    existing = get_existing_measurements(a2l_lines)
    a2l_lines, added = append_measurements(a2l_lines, symbols, existing, ecu_name=args.ecu_name)
    args.a2l_out.write_text("\n".join(a2l_lines) + "\n", encoding="latin-1")
    print(f"Added {added} new MEASUREMENT blocks to {args.a2l_out}")

if __name__ == "__main__":
    main()
